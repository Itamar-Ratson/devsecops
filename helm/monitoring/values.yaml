# Gateway configuration for Grafana HTTPRoute
gateway:
  name: main-gateway
  namespace: gateway

kube-prometheus-stack:
  # Prometheus Configuration
  prometheus:
    prometheusSpec:
      retention: 2d
      retentionSize: "2GB"
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 5Gi
      # Automatically discover ServiceMonitors in all namespaces
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false

  # Grafana Configuration
  grafana:
    enabled: true
    adminPassword: admin
    persistence:
      enabled: true
      size: 1Gi

    # Dashboard providers configuration
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'cilium'
            orgId: 1
            folder: 'Cilium'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/cilium
          - name: 'loki'
            orgId: 1
            folder: 'Loki'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/loki

    # Configure dashboards using grafana.com IDs
    dashboards:
      cilium:
        cilium-metrics:
          gnetId: 16611
          revision: 1
          datasource: Prometheus
        cilium-operator:
          gnetId: 16612
          revision: 1
          datasource: Prometheus
        hubble-metrics:
          gnetId: 16613
          revision: 1
          datasource: Prometheus
        cilium-policy-verdicts:
          json: |
            {
              "__inputs": [
                {
                  "name": "DS_PROMETHEUS",
                  "label": "Prometheus",
                  "description": "",
                  "type": "datasource",
                  "pluginId": "prometheus",
                  "pluginName": "Prometheus"
                }
              ],
              "__elements": {},
              "__requires": [
                {
                  "type": "grafana",
                  "id": "grafana",
                  "name": "Grafana",
                  "version": "9.3.0"
                },
                {
                  "type": "datasource",
                  "id": "prometheus",
                  "name": "Prometheus",
                  "version": "1.0.0"
                },
                {
                  "type": "panel",
                  "id": "table",
                  "name": "Table",
                  "version": ""
                },
                {
                  "type": "panel",
                  "id": "timeseries",
                  "name": "Time series",
                  "version": ""
                }
              ],
              "annotations": {
                "list": [
                  {
                    "builtIn": 1,
                    "datasource": {
                      "type": "grafana",
                      "uid": "-- Grafana --"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "target": {
                      "limit": 100,
                      "matchAny": false,
                      "tags": [],
                      "type": "dashboard"
                    },
                    "type": "dashboard"
                  }
                ]
              },
              "editable": true,
              "fiscalYearStartMonth": 0,
              "graphTooltip": 1,
              "id": null,
              "links": [],
              "liveNow": false,
              "panels": [
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "fixedColor": "green",
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 100,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 0,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "never",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "normal"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "min": 0,
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      }
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "all"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "yellow",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "l3-l4"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "green",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "none"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "semi-dark-red",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byRegexp",
                          "options": "l7/.*"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "mode": "continuous-BlPu"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 0,
                    "y": 0
                  },
                  "id": 2,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (match) (rate(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\", destination=~\"$workload\", source_namespace=~\"$other_namespace|\", source=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "instant": false,
                      "legendFormat": "{{match}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Ingress Policy Verdict Rate per Minute by Match Type",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 100,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 0,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "never",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "normal"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      },
                      "unit": "none"
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "all"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "yellow",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "l3-l4"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "green",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "none"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "red",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byRegexp",
                          "options": "l7/.*"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "mode": "continuous-BlPu"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 12,
                    "y": 0
                  },
                  "id": 8,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "pluginVersion": "9.0.1",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (match) (rate(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\", source=~\"$workload\", destination_namespace=~\"$other_namespace|\", destination=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "instant": false,
                      "legendFormat": "{{match}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Egress Policy Verdict Rate per Minute by Match Type",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "fixedColor": "green",
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 100,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 0,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "never",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "normal"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "min": 0,
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      }
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "redirected"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "yellow",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "forwarded"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "green",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "dropped"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "semi-dark-red",
                              "mode": "fixed"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 0,
                    "y": 9
                  },
                  "id": 9,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (action) (rate(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\", destination=~\"$workload\", source_namespace=~\"$other_namespace|\", source=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "instant": false,
                      "legendFormat": "{{action}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Ingress Policy Verdict Rate per Minute by Action",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "palette-classic"
                      },
                      "custom": {
                        "axisCenteredZero": false,
                        "axisColorMode": "text",
                        "axisLabel": "",
                        "axisPlacement": "auto",
                        "barAlignment": 0,
                        "drawStyle": "line",
                        "fillOpacity": 100,
                        "gradientMode": "none",
                        "hideFrom": {
                          "legend": false,
                          "tooltip": false,
                          "viz": false
                        },
                        "lineInterpolation": "linear",
                        "lineWidth": 0,
                        "pointSize": 5,
                        "scaleDistribution": {
                          "type": "linear"
                        },
                        "showPoints": "never",
                        "spanNulls": false,
                        "stacking": {
                          "group": "A",
                          "mode": "normal"
                        },
                        "thresholdsStyle": {
                          "mode": "off"
                        }
                      },
                      "mappings": [],
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          }
                        ]
                      },
                      "unit": "none"
                    },
                    "overrides": [
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "redirected"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "yellow",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "forwarded"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "green",
                              "mode": "fixed"
                            }
                          }
                        ]
                      },
                      {
                        "matcher": {
                          "id": "byName",
                          "options": "dropped"
                        },
                        "properties": [
                          {
                            "id": "color",
                            "value": {
                              "fixedColor": "red",
                              "mode": "fixed"
                            }
                          }
                        ]
                      }
                    ]
                  },
                  "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 12,
                    "y": 9
                  },
                  "id": 10,
                  "options": {
                    "legend": {
                      "calcs": [],
                      "displayMode": "list",
                      "placement": "bottom",
                      "showLegend": true
                    },
                    "tooltip": {
                      "mode": "single",
                      "sort": "none"
                    }
                  },
                  "pluginVersion": "9.0.1",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (action) (rate(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\", source=~\"$workload\", destination_namespace=~\"$other_namespace|\", destination=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "instant": false,
                      "legendFormat": "{{action}}",
                      "range": true,
                      "refId": "A"
                    }
                  ],
                  "title": "Egress Policy Verdict Rate per Minute by Action",
                  "type": "timeseries"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "thresholds"
                      },
                      "custom": {
                        "align": "auto",
                        "displayMode": "auto",
                        "inspect": false
                      },
                      "mappings": [],
                      "min": 0,
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      }
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 11,
                    "w": 12,
                    "x": 0,
                    "y": 18
                  },
                  "id": 6,
                  "options": {
                    "footer": {
                      "enablePagination": false,
                      "fields": "",
                      "reducer": [
                        "sum"
                      ],
                      "show": false
                    },
                    "showHeader": true,
                    "sortBy": [
                      {
                        "desc": true,
                        "displayName": "Value"
                      }
                    ]
                  },
                  "pluginVersion": "9.3.1",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (source_namespace, source, destination_namespace, destination, match, action) (rate(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\", destination=~\"$workload\", source_namespace=~\"$other_namespace|\", source=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "format": "table",
                      "instant": true,
                      "legendFormat": "source: {{source_namespace}}/{{source}} destination: {{destination_namespace}}/{{destination}} match: {{match}} action: {{action}}",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "title": "Current Ingress Policy Verdict Rate Per Minute",
                  "transformations": [
                    {
                      "id": "filterByValue",
                      "options": {
                        "filters": [
                          {
                            "config": {
                              "id": "equal",
                              "options": {
                                "value": ""
                              }
                            },
                            "fieldName": "Value"
                          }
                        ],
                        "match": "all",
                        "type": "exclude"
                      }
                    },
                    {
                      "id": "organize",
                      "options": {
                        "excludeByName": {
                          "Time": true,
                          "container": true,
                          "destination": false,
                          "direction": true,
                          "endpoint": true,
                          "instance": true,
                          "job": true,
                          "namespace": true,
                          "node": true,
                          "pod": true,
                          "service": true
                        },
                        "indexByName": {
                          "Time": 0,
                          "Value": 7,
                          "action": 6,
                          "destination": 4,
                          "destination_namespace": 3,
                          "match": 5,
                          "source": 2,
                          "source_namespace": 1
                        },
                        "renameByName": {
                          "destination_namespace": "destination namespace",
                          "source_namespace": "source namespace"
                        }
                      }
                    }
                  ],
                  "type": "table"
                },
                {
                  "datasource": {
                    "type": "prometheus",
                    "uid": "PBFA97CFB590B2093"
                  },
                  "description": "",
                  "fieldConfig": {
                    "defaults": {
                      "color": {
                        "mode": "thresholds"
                      },
                      "custom": {
                        "align": "auto",
                        "displayMode": "auto",
                        "inspect": false
                      },
                      "mappings": [],
                      "min": 0,
                      "thresholds": {
                        "mode": "absolute",
                        "steps": [
                          {
                            "color": "green",
                            "value": null
                          },
                          {
                            "color": "red",
                            "value": 80
                          }
                        ]
                      }
                    },
                    "overrides": []
                  },
                  "gridPos": {
                    "h": 11,
                    "w": 12,
                    "x": 12,
                    "y": 18
                  },
                  "id": 7,
                  "options": {
                    "footer": {
                      "enablePagination": false,
                      "fields": "",
                      "reducer": [
                        "sum"
                      ],
                      "show": false
                    },
                    "showHeader": true,
                    "sortBy": [
                      {
                        "desc": true,
                        "displayName": "Value"
                      }
                    ]
                  },
                  "pluginVersion": "9.3.1",
                  "targets": [
                    {
                      "datasource": {
                        "type": "prometheus",
                        "uid": "PBFA97CFB590B2093"
                      },
                      "editorMode": "code",
                      "exemplar": false,
                      "expr": "sum by (destination_namespace, destination, source_namespace, source, match, action) (rate(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\", source=~\"$workload\", destination_namespace=~\"$other_namespace|\", destination=~\"$other_workload\"}[$__rate_interval])) * 60",
                      "format": "table",
                      "instant": true,
                      "legendFormat": "destination: {{destination_namespace}}/{{destination}} source:  {{source_namespace}}/{{source}} match: {{match}} action: {{action}}",
                      "range": false,
                      "refId": "A"
                    }
                  ],
                  "title": "Current Egress Policy Verdict Rate Per Minute",
                  "transformations": [
                    {
                      "id": "filterByValue",
                      "options": {
                        "filters": [
                          {
                            "config": {
                              "id": "equal",
                              "options": {
                                "value": ""
                              }
                            },
                            "fieldName": "Value"
                          }
                        ],
                        "match": "all",
                        "type": "exclude"
                      }
                    },
                    {
                      "id": "organize",
                      "options": {
                        "excludeByName": {
                          "Time": true,
                          "container": true,
                          "destination": false,
                          "direction": true,
                          "endpoint": true,
                          "instance": true,
                          "job": true,
                          "namespace": true,
                          "node": true,
                          "pod": true,
                          "service": true,
                          "source": false
                        },
                        "indexByName": {
                          "Time": 0,
                          "Value": 7,
                          "action": 6,
                          "destination": 2,
                          "destination_namespace": 1,
                          "match": 5,
                          "source": 4,
                          "source_namespace": 3
                        },
                        "renameByName": {
                          "Time": "",
                          "destination_namespace": "destination namespace",
                          "source_namespace": "source namespace"
                        }
                      }
                    }
                  ],
                  "type": "table"
                }
              ],
              "refresh": "5s",
              "schemaVersion": 37,
              "style": "dark",
              "tags": [],
              "templating": {
                "list": [
                  {
                    "current": {},
                    "datasource": {
                      "type": "prometheus",
                      "uid": "PBFA97CFB590B2093"
                    },
                    "definition": "query_result(hubble_policy_verdicts_total)",
                    "description": "The Kubernetes namespace the Network Policies apply to",
                    "hide": 0,
                    "includeAll": true,
                    "multi": true,
                    "name": "namespace",
                    "options": [],
                    "query": {
                      "query": "query_result(hubble_policy_verdicts_total)",
                      "refId": "StandardVariableQuery"
                    },
                    "refresh": 1,
                    "regex": "/.*namespace=\"([^\"]+)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  },
                  {
                    "current": {},
                    "datasource": {
                      "type": "prometheus",
                      "uid": "PBFA97CFB590B2093"
                    },
                    "definition": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\"}, \"workload\", \"$1\", \"destination\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\"}, \"workload\", \"$1\", \"source\", \"(.+)\"))",
                    "description": "The Kubernetes workload the Network Policies apply to",
                    "hide": 0,
                    "includeAll": true,
                    "multi": true,
                    "name": "workload",
                    "options": [],
                    "query": {
                      "query": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\"}, \"workload\", \"$1\", \"destination\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\"}, \"workload\", \"$1\", \"source\", \"(.+)\"))",
                      "refId": "StandardVariableQuery"
                    },
                    "refresh": 1,
                    "regex": "/.*workload=\"([^\"]+)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  },
                  {
                    "current": {},
                    "datasource": {
                      "type": "prometheus",
                      "uid": "PBFA97CFB590B2093"
                    },
                    "definition": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\", destination=~\"$workload\"}, \"other_namespace\", \"$1\", \"source_namespace\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\", source=~\"$workload\"}, \"other_namespace\", \"$1\", \"destination_namespace\", \"(.+)\"))",
                    "description": "The non-targeted Kubernetes namespace (source for Ingress, destination for Egress)",
                    "hide": 0,
                    "includeAll": true,
                    "label": "other namespace",
                    "multi": true,
                    "name": "other_namespace",
                    "options": [],
                    "query": {
                      "query": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\", destination=~\"$workload\"}, \"other_namespace\", \"$1\", \"source_namespace\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\", source=~\"$workload\"}, \"other_namespace\", \"$1\", \"destination_namespace\", \"(.+)\"))",
                      "refId": "StandardVariableQuery"
                    },
                    "refresh": 1,
                    "regex": "/.*other_namespace=\"([^\"]+)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  },
                  {
                    "current": {},
                    "datasource": {
                      "type": "prometheus",
                      "uid": "PBFA97CFB590B2093"
                    },
                    "definition": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\",  destination=~\"$workload\", source_namespace=~\"$other_namespace|\"}, \"workload\", \"$1\", \"source\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\",  source=~\"$workload\", destination_namespace=~\"$other_namespace|\"}, \"workload\", \"$1\", \"destination\", \"(.+)\"))",
                    "description": "The non-targeted Kubernetes workload (source for Ingress, destination for Egress)",
                    "hide": 0,
                    "includeAll": true,
                    "label": "other workload",
                    "multi": true,
                    "name": "other_workload",
                    "options": [],
                    "query": {
                      "query": "query_result(label_replace(hubble_policy_verdicts_total{direction=\"ingress\", destination_namespace=~\"$namespace\",  destination=~\"$workload\", source_namespace=~\"$other_namespace|\"}, \"workload\", \"$1\", \"source\", \"(.+)\") OR label_replace(hubble_policy_verdicts_total{direction=\"egress\", source_namespace=~\"$namespace\",  source=~\"$workload\", destination_namespace=~\"$other_namespace|\"}, \"workload\", \"$1\", \"destination\", \"(.+)\"))",
                      "refId": "StandardVariableQuery"
                    },
                    "refresh": 1,
                    "regex": "/.*workload=\"([^\"]+)\".*/",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                  }
                ]
              },
              "time": {
                "from": "now-6h",
                "to": "now"
              },
              "timepicker": {},
              "timezone": "",
              "title": "Cilium Policy Verdicts",
              "uid": "nLIA2E37k",
              "version": 1,
              "weekStart": "",
              "gnetId": 18015,
              "description": "This dashboard provides visibility on Network Policy application in a Cilium cluster."
            }      loki: {}

    # Grafana ingress/service configuration
    service:
      type: ClusterIP
      port: 80

    # Default datasource configuration
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://monitoring-kube-prometheus-prometheus:9090
            access: proxy
            isDefault: true
          - name: AlertManager
            type: alertmanager
            url: http://monitoring-kube-prometheus-alertmanager:9093
            access: proxy
            jsonData:
              implementation: prometheus
          - name: Loki
            type: loki
            url: http://monitoring-loki-gateway:80
            access: proxy
            jsonData:
              maxLines: 1000

  # AlertManager Configuration (optional, can disable if not needed)
  alertmanager:
    enabled: true
    alertmanagerSpec:
      retention: 24h
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

  # Node Exporter (useful for cluster-level metrics)
  nodeExporter:
    enabled: true

  # Kube State Metrics (Kubernetes cluster metrics)
  kubeStateMetrics:
    enabled: true

  # Default rules (can be customized)
  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8s: true
      kubeApiserver: false
      kubeApiserverAvailability: false
      kubeApiserverSlos: false
      kubelet: true
      kubeProxy: false
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: false
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true

# Loki Configuration (Log Aggregation)
loki:
  # Deploy Loki in single binary mode (simpler for local dev)
  deploymentMode: SingleBinary

  loki:
    # Disable multi-tenancy (not needed for local dev)
    auth_enabled: false
    # Storage configuration
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h
    # Retention configuration (keep logs for 2 days)
    limits_config:
      retention_period: 48h
    # Compactor for retention enforcement
    compactor:
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      delete_request_store: filesystem

  # Single binary deployment
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 5Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

  # Gateway (nginx proxy for Loki)
  gateway:
    enabled: true
    replicas: 1
    service:
      type: ClusterIP
      port: 80

  # Disable unnecessary components for single binary mode
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0

  # Monitoring
  monitoring:
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false
    lokiCanary:
      enabled: false

  # Disable minio (we use filesystem storage)
  minio:
    enabled: false

  # Test pod
  test:
    enabled: false

# Grafana Alloy Configuration (Unified Observability Agent)
alloy:
  # Deploy as DaemonSet to collect logs from all nodes
  controller:
    type: daemonset

  alloy:
    # Alloy configuration in River format
    configMap:
      content: |-
        // Discover Kubernetes pods
        discovery.kubernetes "pods" {
          role = "pod"
        }

        // Relabel discovered pods
        discovery.relabel "pods" {
          targets = discovery.kubernetes.pods.targets

          // Add namespace label
          rule {
            source_labels = ["__meta_kubernetes_namespace"]
            target_label  = "namespace"
          }

          // Add pod name label
          rule {
            source_labels = ["__meta_kubernetes_pod_name"]
            target_label  = "pod"
          }

          // Add container name label
          rule {
            source_labels = ["__meta_kubernetes_pod_container_name"]
            target_label  = "container"
          }

          // Add node name label
          rule {
            source_labels = ["__meta_kubernetes_pod_node_name"]
            target_label  = "node"
          }

          // Set log path
          rule {
            source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
            separator     = "/"
            target_label  = "__path__"
            replacement   = "/var/log/pods/*$1/*.log"
          }
        }

        // Scrape logs from discovered pods
        loki.source.kubernetes "pods" {
          targets    = discovery.relabel.pods.output
          forward_to = [loki.process.pods.receiver]
        }

        // Process logs (extract container runtime metadata)
        loki.process "pods" {
          forward_to = [loki.write.loki.receiver]

          stage.cri {}
        }

        // Send logs to Loki
        loki.write "loki" {
          endpoint {
            url = "http://monitoring-loki-gateway:80/loki/api/v1/push"
          }
        }

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

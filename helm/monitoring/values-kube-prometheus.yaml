kube-prometheus-stack:
  # Simplify resource names (remove release name prefix)
  # This creates services like: prometheus, alertmanager, kube-state-metrics
  nameOverride: ""

  # Prometheus Configuration
  prometheus:
    prometheusSpec:
      retention: 2d
      retentionSize: "2GB"
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 5Gi
      # Automatically discover ServiceMonitors in all namespaces
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false

  # AlertManager Configuration
  alertmanager:
    fullnameOverride: alertmanager

  # Prometheus Operator Configuration
  prometheusOperator:
    fullnameOverride: prometheus-operator

  # Kube State Metrics
  kube-state-metrics:
    fullnameOverride: kube-state-metrics

  # Node Exporter
  prometheus-node-exporter:
    fullnameOverride: node-exporter

  # Grafana Configuration
  grafana:
    fullnameOverride: grafana
    enabled: true
    defaultDatasourceEnabled: false
    adminPassword: admin
    persistence:
      enabled: true
      size: 1Gi

    # Disable sidecar datasources (we define them manually below)
    sidecar:
      datasources:
        enabled: false

    # Dashboard providers configuration
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'cilium'
            orgId: 1
            folder: 'Cilium'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/cilium
          - name: 'loki'
            orgId: 1
            folder: 'Loki'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/loki
          - name: 'tempo'
            orgId: 1
            folder: 'Tempo'
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/tempo

    # Configure dashboards using grafana.com IDs
    dashboards:
      cilium:
        cilium-metrics:
          gnetId: 16611
          revision: 1
          datasource: Prometheus
        cilium-operator:
          gnetId: 16612
          revision: 1
          datasource: Prometheus
        hubble-metrics:
          gnetId: 16613
          revision: 1
          datasource: Prometheus
      loki:
        loki-stack-monitoring:
          gnetId: 14055
          revision: 5
          datasource: Prometheus
      tempo:
        opentelemetry-tempo:
          gnetId: 23242
          revision: 1
          datasource: Prometheus
    # Grafana ingress/service configuration
    service:
      type: ClusterIP
      port: 80

    # Default datasource configuration
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://monitoring-kube-prometheus-prometheus:9090
            access: proxy
            isDefault: true
          - name: AlertManager
            type: alertmanager
            url: http://monitoring-kube-prometheus-alertmanager:9093
            access: proxy
            jsonData:
              implementation: prometheus
          - name: Loki
            type: loki
            url: http://loki-gateway:80
            access: proxy
            jsonData:
              maxLines: 1000
          - name: Tempo
            type: tempo
            url: http://tempo:3200
            access: proxy
            jsonData:
              # Enable trace-to-logs correlation
              tracesToLogsV2:
                datasourceUid: loki
                tags:
                  - key: service.name
                    value: service
                  - key: service.namespace
                    value: namespace
              # Enable trace-to-metrics correlation
              tracesToMetrics:
                datasourceUid: prometheus
                tags:
                  - key: service.name
                    value: service
                  - key: service.namespace
                    value: namespace
              # Enable service map from Prometheus metrics
              serviceMap:
                datasourceUid: prometheus
              # Enable node graph visualization
              nodeGraph:
                enabled: true
              # Enable trace search
              search:
                hide: false

  # AlertManager Configuration (optional, can disable if not needed)
  alertmanager:
    enabled: true
    alertmanagerSpec:
      retention: 24h
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

  # Node Exporter (useful for cluster-level metrics)
  nodeExporter:
    enabled: true

  # Kube State Metrics (Kubernetes cluster metrics)
  kubeStateMetrics:
    enabled: true

  # Default rules (can be customized)
  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8s: true
      kubeApiserver: false
      kubeApiserverAvailability: false
      kubeApiserverSlos: false
      kubelet: true
      kubeProxy: false
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: false
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true


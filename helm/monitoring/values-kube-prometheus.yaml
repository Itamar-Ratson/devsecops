kube-prometheus-stack:
  # Simplify resource names (remove release name prefix)
  # This creates services like: prometheus, alertmanager, kube-state-metrics
  nameOverride: ""

  # Prometheus Configuration (reduced retention/storage for local dev)
  prometheus:
    prometheusSpec:
      retention: 1d
      retentionSize: "1GB"
      # Resources based on metrics (602Mi used, 683Mi max)
      resources:
        requests:
          cpu: 100m
          memory: 700Mi
        limits:
          cpu: "1"
          memory: 1Gi
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
      # Automatically discover ServiceMonitors in all namespaces
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false

  # AlertManager Configuration
  alertmanager:
    fullnameOverride: alertmanager

  # Prometheus Operator Configuration
  prometheusOperator:
    fullnameOverride: prometheus-operator

  # Kube State Metrics
  kube-state-metrics:
    fullnameOverride: kube-state-metrics

  # Node Exporter
  prometheus-node-exporter:
    fullnameOverride: node-exporter

  # Grafana Configuration
  grafana:
    fullnameOverride: grafana
    enabled: true
    defaultDatasourceEnabled: false
    adminPassword: admin
    persistence:
      enabled: true
      size: 1Gi

    # Disable init container that changes ownership (causes permission issues)
    initChownData:
      enabled: false

    # Sidecar configuration
    sidecar:
      datasources:
        enabled: false
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
        searchNamespace: ALL
        folderAnnotation: grafana_folder
        # Folder annotation for kube-prometheus-stack built-in dashboards
        annotations:
          grafana_folder: "Prometheus Stack"
        provider:
          foldersFromFilesStructure: true

    # Dashboards are provisioned via ConfigMaps (see templates/grafana-dashboards.yaml)
    # The sidecar will automatically load them from ConfigMaps with label grafana_dashboard=1
    # Grafana ingress/service configuration
    service:
      type: ClusterIP
      port: 80

    # Default datasource configuration
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            uid: prometheus
            url: http://monitoring-kube-prometheus-prometheus:9090
            access: proxy
            isDefault: true
          - name: AlertManager
            type: alertmanager
            url: http://monitoring-kube-prometheus-alertmanager:9093
            access: proxy
            jsonData:
              implementation: prometheus
          - name: Loki
            type: loki
            uid: loki
            url: http://loki-gateway:80
            access: proxy
            jsonData:
              maxLines: 1000
          - name: Tempo
            type: tempo
            uid: tempo
            url: http://tempo:3200
            access: proxy
            jsonData:
              # Enable trace-to-logs correlation
              tracesToLogsV2:
                datasourceUid: loki
                tags:
                  - key: service.name
                    value: service
                  - key: service.namespace
                    value: namespace
              # Enable trace-to-metrics correlation
              tracesToMetrics:
                datasourceUid: prometheus
                tags:
                  - key: service.name
                    value: service
                  - key: service.namespace
                    value: namespace
              # Enable service map from Prometheus metrics
              serviceMap:
                datasourceUid: prometheus
              # Enable node graph visualization
              nodeGraph:
                enabled: true
              # Enable trace search
              search:
                hide: false

  # AlertManager Configuration (optional, can disable if not needed)
  alertmanager:
    enabled: true
    alertmanagerSpec:
      retention: 24h
      resources:
        requests:
          cpu: 10m
          memory: 64Mi  # Reduced based on metrics (27Mi used, 30Mi max)
        limits:
          cpu: 100m
          memory: 128Mi
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 500Mi

  # Node Exporter (useful for cluster-level metrics)
  nodeExporter:
    enabled: true

  # Kube State Metrics (Kubernetes cluster metrics)
  kubeStateMetrics:
    enabled: true

  # Default rules (can be customized)
  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8s: true
      kubeApiserver: false
      kubeApiserverAvailability: false
      kubeApiserverSlos: false
      kubelet: true
      kubeProxy: false
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: false
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true


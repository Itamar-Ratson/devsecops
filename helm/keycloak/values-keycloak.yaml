keycloakx:
  # Use Quarkus-based Keycloak (keycloakx)
  image:
    repository: quay.io/keycloak/keycloak
    tag: "24.0"
    pullPolicy: IfNotPresent

  # Single replica for dev environment
  replicas: 1

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi

  # Use embedded dev-file database for dev (no PostgreSQL dependency)
  database:
    vendor: dev-file

  # Keycloak command configuration
  command:
    - "/opt/keycloak/bin/kc.sh"
    - "start"
    - "--http-enabled=true"
    - "--http-port=8080"
    - "--hostname=keycloak.localhost"
    - "--hostname-strict=false"
    - "--proxy-headers=xforwarded"
    - "--http-relative-path=/"
    - "--import-realm"
    - "--cache=local"  # Disable clustering for single-replica dev environment

  # Admin credentials and realm import settings
  extraEnv: |
    - name: KEYCLOAK_ADMIN
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-credentials
          key: admin-user
    - name: KEYCLOAK_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-credentials
          key: admin-password
    - name: KC_SPI_IMPORT_IMPORTER_STRATEGY
      value: "OVERWRITE_EXISTING"

  # Init container to substitute env vars in realm JSON
  extraInitContainers: |
    - name: envsubst-realm
      image: alpine:3.19
      command:
        - sh
        - -c
        - |
          sed -e "s|\${ARGOCD_CLIENT_SECRET}|$ARGOCD_CLIENT_SECRET|g" \
              -e "s|\${GRAFANA_CLIENT_SECRET}|$GRAFANA_CLIENT_SECRET|g" \
              -e "s|\${VAULT_CLIENT_SECRET}|$VAULT_CLIENT_SECRET|g" \
              -e "s|\${HEADLAMP_CLIENT_SECRET}|$HEADLAMP_CLIENT_SECRET|g" \
              /realm-template/devsecops-realm.json > /realm-output/devsecops-realm.json
      env:
        - name: ARGOCD_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc-clients
              key: argocd-client-secret
        - name: GRAFANA_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc-clients
              key: grafana-client-secret
        - name: VAULT_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc-clients
              key: vault-client-secret
        - name: HEADLAMP_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oidc-clients
              key: headlamp-client-secret
      volumeMounts:
        - name: realm-template
          mountPath: /realm-template
          readOnly: true
        - name: realm-config
          mountPath: /realm-output

  # Mount realm configuration
  extraVolumes: |
    - name: realm-template
      configMap:
        name: keycloak-realm-config
    - name: realm-config
      emptyDir: {}

  extraVolumeMounts: |
    - name: realm-config
      mountPath: /opt/keycloak/data/import
      readOnly: true

  # Service configuration
  service:
    type: ClusterIP
    httpPort: 8080

  # HTTP service (no TLS - terminated at Gateway)
  http:
    relativePath: "/"

  # Disable ingress (we use Gateway API HTTPRoute)
  ingress:
    enabled: false

  # Startup probe (Keycloak can be slow to start)
  startupProbe: |
    httpGet:
      path: /health/started
      port: http
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 1
    failureThreshold: 60

  # Liveness probe
  livenessProbe: |
    httpGet:
      path: /health/live
      port: http
    initialDelaySeconds: 0
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Readiness probe
  readinessProbe: |
    httpGet:
      path: /health/ready
      port: http
    initialDelaySeconds: 0
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

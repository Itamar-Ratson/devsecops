# Wave 4: Secrets - HashiCorp Vault (after VSO provides CRDs)
{{- if .Values.gitops.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: {{ .Values.gitops.repoURL }}
    targetRevision: {{ .Values.gitops.targetRevision }}
    path: helm/vault
    helm:
      valueFiles:
        - ../ports.yaml
        - values.yaml
      valuesObject:
        vault:
          server:
            standalone:
              config: |
                ui = true
                listener "tcp" {
                  tls_disable = 1
                  address = "[::]:8200"
                  cluster_address = "[::]:8201"
                  telemetry {
                    unauthenticated_metrics_access = true
                  }
                }
                storage "file" {
                  path = "/vault/data"
                }
                seal "transit" {
                  address = "http://{{ .Values.transitVaultIP }}:8200"
                  key_name = "autounseal"
                  mount_path = "transit/"
                }
                telemetry {
                  prometheus_retention_time = "30s"
                  disable_hostname = true
                }
  destination:
    server: https://kubernetes.default.svc
    namespace: vault
  ignoreDifferences:
    - group: ""
      kind: ConfigMap
      jqPathExpressions:
        - .data
    - group: apps
      kind: StatefulSet
      jqPathExpressions:
        - .spec.volumeClaimTemplates
        - .spec.template.metadata
    - group: cilium.io
      kind: CiliumNetworkPolicy
      jsonPointers:
        - /spec
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      jsonPointers:
        - /spec/parentRefs
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
{{- end }}

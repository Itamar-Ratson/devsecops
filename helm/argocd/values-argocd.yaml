argo-cd:
  # Global settings
  global:
    # Disable network policies - we manage via CiliumNetworkPolicy
    networkPolicy:
      create: false

  # ArgoCD Server (UI + API)
  server:
    replicas: 1

    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi  # Reduced based on metrics (33Mi used, 50Mi max)

    # Expose metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false  # We create our own ServiceMonitor

    # Insecure mode (terminate TLS at gateway)
    extraArgs:
      - --insecure

    service:
      type: ClusterIP
      servicePortHttp: 8080
      servicePortHttps: 443

  # Repo Server - handles Git operations
  repoServer:
    replicas: 1

    resources:
      limits:
        cpu: "1"
        memory: 384Mi  # Increased from 256Mi - OOMKilled during chart rendering
      requests:
        cpu: 50m  # Reduced from 250m - actual usage ~13-21m
        memory: 150Mi  # Reduced from 320Mi - actual usage ~91Mi

    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Application Controller - reconciles desired vs actual state
  controller:
    replicas: 1

    resources:
      limits:
        cpu: "2"
        memory: 2Gi
      requests:
        cpu: 250m
        memory: 1Gi

    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Redis - used for caching
  redis:
    enabled: true
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

  # Disable HA components for minimal installation
  redis-ha:
    enabled: false

  # ApplicationSet Controller - for generating Applications
  applicationSet:
    enabled: true
    replicas: 1
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 25m
        memory: 64Mi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Notifications Controller - disable unless needed
  notifications:
    enabled: false

  # Dex - OIDC provider for Keycloak SSO
  # Works because ArgoCD self-manages after bootstrap, and VSO is available by then
  dex:
    enabled: true
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 25m
        memory: 64Mi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false
    # Inject OIDC client secret from Vault-synced secret
    env:
      - name: DEX_KEYCLOAK_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: argocd-oidc-secret
            key: argocd-client-secret

  # CRDs - install via Helm
  crds:
    install: true
    keep: true

  # ConfigMaps for ArgoCD configuration
  configs:
    # Repository credentials are automatically configured by setup.sh:
    # - SSH key generated at ~/.ssh/argocd-deploy-key
    # - Secret created, sealed, and applied as SealedSecret
    # - Public key displayed for adding to GitHub as deploy key
    #
    # For manual setup or additional repos, create a SealedSecret:
    # kubectl create secret generic argocd-repo-creds -n argocd \
    #   --from-literal=type=git \
    #   --from-literal=url=git@github.com:yourorg \
    #   --from-file=sshPrivateKey=/path/to/key \
    #   --dry-run=client -o yaml | \
    #   kubectl label --local -f - argocd.argoproj.io/secret-type=repo-creds -o yaml | \
    #   kubeseal --controller-name=sealed-secrets --controller-namespace=sealed-secrets -o yaml | \
    #   kubectl apply -f -
    credentialTemplates: {}
    repositories: {}

    params:
      server.enable.gzip: true
      application.instanceLabelKey: argocd.argoproj.io/instance

    cm:
      # ArgoCD server URL (used for OIDC callbacks)
      url: https://argocd.localhost

      # Dex configuration for Keycloak OIDC
      dex.config: |
        connectors:
          - type: oidc
            id: keycloak
            name: Keycloak
            config:
              issuer: https://keycloak.localhost/realms/devsecops
              clientID: argocd
              clientSecretEnv: DEX_KEYCLOAK_CLIENT_SECRET
              insecureSkipEmailVerified: true
              insecureEnableGroups: true
              scopes:
                - openid
                - profile
                - email
                - groups
              getUserInfo: true

    rbac:
      policy.csv: |
        # Admins group has full admin access
        g, admins, role:admin
        # Developers group has admin access (can manage apps)
        g, developers, role:admin
        # Viewers group has read-only access
        g, viewers, role:readonly
      policy.default: role:readonly
      scopes: "[groups]"

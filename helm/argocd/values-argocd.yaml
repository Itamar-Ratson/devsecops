argo-cd:
  # Global settings
  global:
    # Disable network policies - we manage via CiliumNetworkPolicy
    networkPolicy:
      create: false

  # ArgoCD Server (UI + API)
  server:
    replicas: 1

    # Argo Rollouts extension for UI integration
    extensions:
      enabled: true
      extensionList:
        - name: argo-rollouts
          env:
            - name: EXTENSION_URL
              value: https://github.com/argoproj-labs/rollout-extension/releases/download/v0.3.6/extension.tar

    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi  # Reduced based on metrics (33Mi used, 50Mi max)

    # Expose metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false  # We create our own ServiceMonitor

    # Insecure mode (terminate TLS at gateway)
    extraArgs:
      - --insecure

    service:
      type: ClusterIP
      servicePortHttp: 8080
      servicePortHttps: 443

  # Repo Server - handles Git operations
  repoServer:
    replicas: 1

    resources:
      limits:
        cpu: "1"
        memory: 384Mi  # Increased from 256Mi - OOMKilled during chart rendering
      requests:
        cpu: 50m  # Reduced from 250m - actual usage ~13-21m
        memory: 150Mi  # Reduced from 320Mi - actual usage ~91Mi

    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Application Controller - reconciles desired vs actual state
  controller:
    replicas: 1

    resources:
      limits:
        cpu: "2"
        memory: 2Gi
      requests:
        cpu: 250m
        memory: 1Gi

    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Redis - used for caching
  redis:
    enabled: true
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

  # Disable HA components for minimal installation
  redis-ha:
    enabled: false

  # ApplicationSet Controller - for generating Applications
  applicationSet:
    enabled: true
    replicas: 1
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 25m
        memory: 64Mi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false

  # Notifications Controller - disable unless needed
  notifications:
    enabled: false

  # Dex - disabled, using direct OIDC instead
  dex:
    enabled: false

  # CRDs - pre-installed by cluster-bootstrap Terraform module
  crds:
    install: false
    keep: true

  # ConfigMaps for ArgoCD configuration
  configs:
    # Repository credentials are configured by Terraform (argocd-bootstrap module):
    # - SSH deploy key sealed and applied as SealedSecret
    # - Public key displayed for adding to GitHub as deploy key
    #
    # For manual setup or additional repos, create a SealedSecret:
    # kubectl create secret generic argocd-repo-creds -n argocd \
    #   --from-literal=type=git \
    #   --from-literal=url=git@github.com:yourorg \
    #   --from-file=sshPrivateKey=/path/to/key \
    #   --dry-run=client -o yaml | \
    #   kubectl label --local -f - argocd.argoproj.io/secret-type=repo-creds -o yaml | \
    #   kubeseal --controller-name=sealed-secrets --controller-namespace=sealed-secrets -o yaml | \
    #   kubectl apply -f -
    credentialTemplates: {}
    repositories: {}

    params:
      server.enable.gzip: true
      application.instanceLabelKey: argocd.argoproj.io/instance
      # Server-side diff avoids K8s 1.35 schema mismatch errors
      # (e.g. .status.terminatingReplicas not in ArgoCD's embedded schema)
      controller.diff.server.side: "true"

    cm:
      # ArgoCD server URL (used for OIDC callbacks)
      url: https://argocd.localhost

      # Override default resource.exclusions to allow EndpointSlice
      # (needed for Zot registry cache external backend in gateway chart)
      resource.exclusions: |
        - apiGroups:
          - coordination.k8s.io
          kinds:
          - Lease
        - apiGroups:
          - authentication.k8s.io
          - authorization.k8s.io
          kinds:
          - SelfSubjectReview
          - TokenReview
          - LocalSubjectAccessReview
          - SelfSubjectAccessReview
          - SelfSubjectRulesReview
          - SubjectAccessReview
        - apiGroups:
          - certificates.k8s.io
          kinds:
          - CertificateSigningRequest
        - apiGroups:
          - cert-manager.io
          kinds:
          - CertificateRequest
        - apiGroups:
          - cilium.io
          kinds:
          - CiliumIdentity
          - CiliumEndpoint
          - CiliumEndpointSlice
        - apiGroups:
          - kyverno.io
          - reports.kyverno.io
          - wgpolicyk8s.io
          kinds:
          - PolicyReport
          - ClusterPolicyReport
          - EphemeralReport
          - ClusterEphemeralReport
          - AdmissionReport
          - ClusterAdmissionReport
          - BackgroundScanReport
          - ClusterBackgroundScanReport
          - UpdateRequest

      # Skip TLS verification for OIDC provider (self-signed certs in dev)
      oidc.tls.insecure.skip.verify: "true"

      # Direct OIDC configuration for Keycloak (no Dex)
      oidc.config: |
        name: Keycloak
        issuer: https://keycloak.localhost/realms/devsecops
        clientID: argocd
        clientSecret: $argocd-oidc-secret:oidc.keycloak.clientSecret
        requestedScopes: ["openid", "profile", "email", "groups"]
        requestedIDTokenClaims: {"groups": {"essential": true}}

    rbac:
      policy.csv: |
        # Admins group has full admin access
        g, admins, role:admin
        # Developers group has admin access (can manage apps)
        g, developers, role:admin
        # Viewers group has read-only access
        g, viewers, role:readonly
      policy.default: role:readonly
      scopes: "[groups]"

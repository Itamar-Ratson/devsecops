apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-oidc-proxy
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: kube-oidc-proxy
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-oidc-proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kube-oidc-proxy
    spec:
      serviceAccountName: kube-oidc-proxy
      securityContext:
        runAsNonRoot: {{ .Values.securityContext.runAsNonRoot }}
        runAsUser: {{ .Values.securityContext.runAsUser }}
        seccompProfile:
          type: {{ .Values.securityContext.seccompProfile.type }}
      initContainers:
        - name: wait-for-certs
          image: "{{ .Values.initImage.repository }}:{{ .Values.initImage.tag }}"
          command:
            - sh
            - -c
            - |
              echo "Waiting for TLS cert and CA bundle..."
              until [ -f /etc/tls/tls.crt ] && [ -f /etc/ssl/certs/oidc-ca/ca.crt ]; do
                sleep 2
              done
              echo "Certificates ready."
          volumeMounts:
            - name: tls
              mountPath: /etc/tls
              readOnly: true
            - name: oidc-ca
              mountPath: /etc/ssl/certs/oidc-ca
              readOnly: true
          resources:
            requests:
              cpu: 5m
              memory: 8Mi
            limits:
              cpu: 10m
              memory: 16Mi
          securityContext:
            allowPrivilegeEscalation: {{ .Values.securityContext.allowPrivilegeEscalation }}
            capabilities:
              drop:
                {{- toYaml .Values.securityContext.capabilities.drop | nindent 16 }}
      containers:
        - name: kube-oidc-proxy
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - kube-oidc-proxy
          args:
            - --secure-port=8443
            - --tls-cert-file=/etc/tls/tls.crt
            - --tls-private-key-file=/etc/tls/tls.key
            - --oidc-issuer-url={{ .Values.oidc.issuerUrl }}
            - --oidc-client-id={{ .Values.oidc.clientId }}
            - --oidc-username-claim={{ .Values.oidc.usernameClaim }}
            - --oidc-groups-claim={{ .Values.oidc.groupsClaim }}
            - --oidc-ca-file=/etc/ssl/certs/oidc-ca/ca.crt
          ports:
            - name: https
              containerPort: 8443
              protocol: TCP
          volumeMounts:
            - name: tls
              mountPath: /etc/tls
              readOnly: true
            - name: oidc-ca
              mountPath: /etc/ssl/certs/oidc-ca
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: {{ .Values.securityContext.allowPrivilegeEscalation }}
            capabilities:
              drop:
                {{- toYaml .Values.securityContext.capabilities.drop | nindent 16 }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          # kube-oidc-proxy uses TCP probe on the secure port
          readinessProbe:
            tcpSocket:
              port: 8443
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 8443
            initialDelaySeconds: 15
            periodSeconds: 20
      volumes:
        - name: tls
          secret:
            secretName: {{ .Values.tls.secretName }}
        - name: oidc-ca
          configMap:
            name: gateway-ca-bundle
            optional: true

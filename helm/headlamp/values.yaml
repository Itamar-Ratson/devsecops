# Gateway configuration
gateway:
  name: main-gateway
  namespace: gateway

# Headlamp configuration
headlamp:
  replicaCount: 1

  # v0.28.0 is the last version with working OIDC refresh tokens
  # v0.39.0 has "failed to append ca cert to pool" and refresh token bugs
  # See: https://github.com/kubernetes-sigs/headlamp/issues/3143
  image:
    registry: ghcr.io
    repository: headlamp-k8s/headlamp
    tag: "v0.28.0"

  config:
    # Must use in-cluster mode for OIDC to work
    inCluster: true
    oidc:
      # Do not create secret from values - we use external secret from VSO
      secret:
        create: false
      # Client secret from VaultStaticSecret
      externalSecret:
        enabled: true
        name: headlamp-oidc-secret
    extraArgs: []

  # Cluster discovery from ArgoCD secrets
  # Headlamp reads secrets with label: argocd.argoproj.io/secret-type=cluster
  clusterRoleBinding:
    create: true
    clusterRoleName: cluster-admin

  service:
    type: ClusterIP
    port: 80

  # Disable built-in ingress (we use HTTPRoute)
  ingress:
    enabled: false

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Disable default SA mount - we'll create our own with custom CA
  automountServiceAccountToken: false

  # Mount CA bundle from trust-manager for OIDC TLS verification
  volumes:
    - name: ca-bundle
      configMap:
        name: gateway-ca-bundle
        optional: true  # Don't fail if trust-manager hasn't synced yet
    # Custom ServiceAccount volume with our CA
    - name: custom-sa
      projected:
        sources:
          # Token from the ServiceAccount
          - serviceAccountToken:
              path: token
              expirationSeconds: 3600
          # Our combined CA bundle (includes Kubernetes + gateway CA)
          - configMap:
              name: gateway-ca-bundle
              items:
                - key: ca.crt
                  path: ca.crt
          # Namespace
          - downwardAPI:
              items:
                - path: namespace
                  fieldRef:
                    fieldPath: metadata.namespace

  volumeMounts:
    - name: ca-bundle
      mountPath: /etc/headlamp/certs/ca.crt
      subPath: ca.crt
      readOnly: true
    # Mount custom SA to the standard path
    - name: custom-sa
      mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      readOnly: true

  # Point Go's TLS to use our CA bundle for OIDC connections
  env:
    - name: SSL_CERT_FILE
      value: /etc/headlamp/certs/ca.crt
    # Point Headlamp to kube-oidc-proxy instead of real API server
    - name: KUBERNETES_SERVICE_HOST
      value: kube-oidc-proxy.kube-oidc-proxy.svc
    - name: KUBERNETES_SERVICE_PORT
      value: "443"

  # Run as non-root
  securityContext:
    runAsNonRoot: true
    runAsUser: 100
    runAsGroup: 101

  podSecurityContext:
    fsGroup: 101

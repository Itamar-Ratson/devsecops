#cloud-config
hostname: vault
fqdn: vault.k8s.local

ssh_authorized_keys:
  - ${ssh_public_key}

packages:
  - curl
  - unzip
  - jq
  - gpg

write_files:
  - path: /etc/systemd/system/vault.service
    content: |
      [Unit]
      Description=Vault
      Documentation=https://www.vaultproject.io/docs/
      Requires=network-online.target
      After=network-online.target

      [Service]
      User=vault
      Group=vault
      ExecStart=/usr/bin/vault server -dev -dev-listen-address=0.0.0.0:8200 -dev-root-token-id=root
      ExecReload=/bin/kill -HUP $MAINPID
      KillMode=process
      Restart=on-failure
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
  - path: /etc/profile.d/vault.sh
    content: |
      export VAULT_ADDR=http://127.0.0.1:8200
      export VAULT_TOKEN=root

runcmd:
  - curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
  - apt-get update
  - apt-get install -y vault=${vault_version}-*
  - mkdir -p /home/vault && chown vault:vault /home/vault
  - systemctl daemon-reload
  - systemctl enable vault
  - systemctl start vault
